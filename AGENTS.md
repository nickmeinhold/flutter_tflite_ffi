# AGENTS.md

This file provides context for AI coding assistants working on this Flutter FFI plugin.

## Stack

- **Flutter/Dart**: SDK >= 3.0.0
- **FFI**: Direct bindings to TensorFlow Lite C API via `dart:ffi`
- **Platforms**: Android (arm64-v8a) and iOS only
- **Linting**: `flutter_lints` package

## Project Structure

```
lib/
├── flutter_tflite_ffi.dart      # Public API exports
└── src/
    ├── bindings/
    │   ├── bindings_global.dart                        # DynamicLibrary loading
    │   └── flutter_tflite_ffi_bindings_generated.dart  # Auto-generated FFI bindings
    ├── exceptions/
    │   └── t_f_lite_status_exception.dart              # TFLite error handling
    ├── utils/
    │   └── string_extensions.dart                      # C string helpers
    ├── interpeter.dart           # Interpreter interface & implementation
    ├── tensor_info.dart          # Tensor metadata
    └── encoded_file_image.dart   # Image loading utilities
android/                          # Android native build config
ios/                              # iOS native build config + vendored framework
src/                              # Native C sources and prebuilt .so files
example/                          # MobileNet classification demo app
```

## Commands

```bash
# Install dependencies
flutter pub get

# Run analysis
dart analyze

# Format code
dart format .

# Run tests (macOS only - see Testing section)
flutter test

# Regenerate FFI bindings (requires TensorFlow headers)
dart run ffigen --config ffigen.yaml
```

## Testing

- Test support is currently **macOS only**
- Tests require `test/libtensorflowlite_c.dylib` to be present
- The `FLUTTER_TEST` environment variable is used to detect test mode
- PRs adding test support for other platforms are welcome

## Code Style

- Follow `flutter_lints` rules (extends Flutter's recommended lints)
- Files ending in `_generated.dart` are auto-generated and excluded from analysis
- Use `TfLiteType` and `TfLiteStatus` enums for type safety (not raw ints)
- Exception messages should map TfLiteStatus codes to human-readable descriptions

## FFI Considerations

### Generated Bindings
- `lib/src/bindings/flutter_tflite_ffi_bindings_generated.dart` is auto-generated by `ffigen`
- Do NOT manually edit this file
- Regenerate with `dart run ffigen --config ffigen.yaml` if TFLite headers change

### Enum Type Erasure
- `ffigen` erases enum types to `int` (known issue #236)
- Manual `int -> String` mappings exist in:
  - `t_f_lite_status_exception.dart` (TfLiteStatus codes)
  - `tensor_info.dart` (TfLiteType values)
- When adding new enum values, update these mappings

### Memory Management
- Use `malloc.allocate()` and `malloc.free()` for C memory
- Always free allocated C memory to prevent leaks
- The `Interpreter.delete()` method handles interpreter cleanup

### Native Libraries
- **Android**: Prebuilt `.so` files in `src/android/${ANDROID_ABI}/`
- **iOS**: Vendored `TensorFlowLiteC.framework` in `ios/`
- Do NOT modify or replace these without testing on real devices

## Boundaries

### Never modify
- `lib/src/bindings/flutter_tflite_ffi_bindings_generated.dart` - auto-generated
- Prebuilt native libraries (`.so`, `.framework` files)
- `.tflite` model files in example app

### Be careful with
- `ffigen.yaml` - changes affect all generated bindings
- Platform-specific build files (`CMakeLists.txt`, `build.gradle`, `*.podspec`)
- `bindings_global.dart` - platform detection and library loading

## Adding New Features

1. Add public API to `lib/flutter_tflite_ffi.dart` exports
2. Implement in `lib/src/` with appropriate organization
3. Run `dart analyze` and `dart format .` before committing
4. Update example app to demonstrate new functionality if applicable

## Common Tasks

### Adding support for a new tensor data type
1. Add type handling in `NativeInterpreter.setInputTensorData()` (`interpeter.dart`)
2. Add type handling in `NativeInterpreter.getOutputTensorData()` (`interpeter.dart`)
3. Update type name mapping in `tensor_info.dart` if needed

### Adding a new TfLiteStatus error code
1. Add the enum value mapping in `t_f_lite_status_exception.dart`
2. Provide a descriptive error message
